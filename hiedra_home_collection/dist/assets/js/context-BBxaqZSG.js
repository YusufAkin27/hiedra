import{r as t,j as e}from"./react-vendor-DfawjiNX.js";const i=t.createContext(),a="hiedra_auth",r=t=>{try{const e=(new Date).getTime()+2592e6,i={...t,expiry:e,savedAt:(new Date).getTime()};localStorage.setItem(a,JSON.stringify(i))}catch(e){}},s=()=>{const e=t.useContext(i);if(!e)throw Error("useAuth must be used within AuthProvider");return e},o=({children:s})=>{const[o,c]=t.useState(null),[n,u]=t.useState(!0),[l,m]=t.useState(null);t.useEffect(()=>{const t=(()=>{try{const t=localStorage.getItem(a);if(!t)return null;const e=JSON.parse(t);return e.expiry&&(new Date).getTime()>e.expiry?(localStorage.removeItem(a),null):e}catch(t){return null}})();t&&(c(t.user),m(t.accessToken)),u(!1)},[]);const d=async()=>{try{const e=(t,e=3e3)=>Promise.race([fetch(t,{method:"GET",headers:{Accept:"application/json"}}),new Promise((t,i)=>setTimeout(()=>i(Error("Timeout")),e))]);try{const t=await e("https://api.ipify.org?format=json",3e3);if(t.ok){const e=await t.json();if(e.ip&&""!==e.ip.trim()&&"127.0.0.1"!==e.ip&&"::1"!==e.ip)return e.ip.trim()}}catch(t){}try{const t=await e("https://api.ipify.org?format=text",3e3);if(t.ok){const e=await t.text();if(e&&""!==e.trim()&&"127.0.0.1"!==e.trim()&&"::1"!==e.trim())return e.trim()}}catch(t){}}catch(t){}return null},p={user:o,accessToken:l,isLoading:n,isAuthenticated:!!o,login:async(t,e)=>({success:!1,error:"Lütfen e-posta doğrulama kodu ile giriş yapın"}),logout:()=>{c(null),m(null),localStorage.removeItem(a)},requestCode:async t=>{try{const e="http://localhost:8080/api",i=await d(),a=await fetch(e+"/auth/request-code",{method:"POST",headers:{"Content-Type":"application/json",...i&&{"X-Client-IP":i}},body:JSON.stringify({email:t})}),r=await a.json();if(!a.ok)throw Error(r.message||"Kod gönderilemedi");if(r.isSuccess||r.success)return{success:!0,message:r.message};throw Error(r.message||"Kod gönderilemedi")}catch(e){return{success:!1,error:e.message||"Kod gönderilirken bir hata oluştu"}}},verifyCode:async(t,e)=>{try{const i="http://localhost:8080/api",a=await d(),s=await fetch(i+"/auth/verify-code",{method:"POST",headers:{"Content-Type":"application/json",...a&&{"X-Client-IP":a}},body:JSON.stringify({email:t,code:e})});if(!s.ok){const t=await s.json().catch(()=>({}));throw Error(t.message||"Doğrulama başarısız")}const o=await s.json();if(o.isSuccess||o.success){const e={user:o.data?.user||{email:t},accessToken:o.data?.accessToken||o.data?.token};return c(e.user),m(e.accessToken),r(e),{success:!0}}throw Error(o.message||"Doğrulama başarısız")}catch(i){return{success:!1,error:i.message||"Doğrulama yapılırken bir hata oluştu"}}},setUser:c,setAccessToken:m,saveAuthToStorage:r};return e.jsx(i.Provider,{value:p,children:s})},c=t.createContext(),n="hiedra_cart",u=t=>{try{const e={items:t,expiry:(new Date).getTime()+2592e6,savedAt:(new Date).getTime()};localStorage.setItem(n,JSON.stringify(e))}catch(e){}},l=()=>{const e=t.useContext(c);if(!e)throw Error("useCart must be used within CartProvider");return e},m=({children:i})=>{const{isAuthenticated:a,accessToken:r}=s(),[o,l]=t.useState([]),[m,d]=t.useState(!1),p=async()=>{try{d(!0);let t=null;a&&r||(t=localStorage.getItem("guestUserId"));const e="http://localhost:8080/api/cart"+(t?"?guestUserId="+t:""),i=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json",...r&&{Authorization:"Bearer "+r}}});if(!i.ok)return l([]),[];const s=await i.json();if(s.isSuccess||s.success){const t=((s.data||s).items||[]).map(t=>{const e=t.subtotal?"string"==typeof t.subtotal?parseFloat(t.subtotal):parseFloat(t.subtotal.toString()):0,i=t.unitPrice?"string"==typeof t.unitPrice?parseFloat(t.unitPrice):parseFloat(t.unitPrice.toString()):0,a=t.product?.price?"string"==typeof t.product.price?parseFloat(t.product.price):parseFloat(t.product.price.toString()):0;return{id:t.product?.id||t.productId,name:t.product?.name||t.productName||"Ürün",price:i>0?i:a>0?a:0,image:t.product?.coverImageUrl||t.product?.image||"/images/perde1kapak.jpg",quantity:t.quantity||1,category:t.product?.category?.name||t.product?.category||"Genel",customizations:t.width||t.height||t.pleatType?{en:t.width,boy:t.height,pileSikligi:t.pleatType,calculatedPrice:e>0?e:i>0?i*(t.quantity||1):0}:null,itemKey:t.id?"backend_"+t.id:null,cartItemId:t.id}});return l(t),u(t),t}return l([]),[]}catch(t){return l([]),[]}finally{d(!1)}},h=t.useRef(!1),g=t.useRef({isAuthenticated:a,accessToken:r});t.useEffect(()=>{if(!h.current){const t=(()=>{try{const t=localStorage.getItem(n);if(!t)return[];const e=JSON.parse(t);return e.expiry&&(new Date).getTime()>e.expiry?(localStorage.removeItem(n),[]):e.items||[]}catch(t){return[]}})();t&&t.length>0&&l(t),h.current=!0}},[]),t.useEffect(()=>{g.current.isAuthenticated===a&&g.current.accessToken===r||!h.current?h.current||(g.current={isAuthenticated:a,accessToken:r}):(p(),g.current={isAuthenticated:a,accessToken:r})},[a,r]),t.useEffect(()=>{u(o)},[o]);const y=(t,e=null)=>{l(i=>e?i.filter(t=>t.itemKey!==e):i.filter(e=>e.id!==t))},f=t.useCallback(()=>o.reduce((t,e)=>t+(e.customizations?.calculatedPrice||e.price)*e.quantity,0),[o]),S=t.useCallback(()=>o.reduce((t,e)=>t+e.quantity,0),[o]),k=t.useMemo(()=>f(),[f]),T=t.useMemo(()=>S(),[S]);return e.jsx(c.Provider,{value:{cartItems:o,addToCart:(t,e={})=>{l(i=>{const a={...t,quantity:e.quantity||1,customizations:e.en||e.boy||e.pileSikligi?{en:e.en,boy:e.boy,pileSikligi:e.pileSikligi,calculatedPrice:e.calculatedPrice||t.price}:null},r=e.en||e.boy||e.pileSikligi?`${t.id}_${e.en}_${e.boy}_${e.pileSikligi}`:t.id;return i.find(e=>e.customizations&&a.customizations?e.id===t.id&&e.customizations.en===a.customizations.en&&e.customizations.boy===a.customizations.boy&&e.customizations.pileSikligi===a.customizations.pileSikligi:e.id===t.id&&!e.customizations&&!a.customizations)?i.map(i=>(i.customizations&&a.customizations?i.id!==t.id||i.customizations.en!==a.customizations.en||i.customizations.boy!==a.customizations.boy||i.customizations.pileSikligi!==a.customizations.pileSikligi:i.id!==t.id||i.customizations||a.customizations)?i:{...i,quantity:i.quantity+(e.quantity||1)}):[...i,{...a,itemKey:r}]})},removeFromCart:y,updateQuantity:(t,e,i=null)=>{e>0?l(a=>a.map(a=>i?a.itemKey===i?{...a,quantity:e}:a:a.id!==t||a.itemKey?a:{...a,quantity:e})):y(t,i)},clearCart:()=>{l([]),localStorage.removeItem(n)},getCartTotal:f,getCartItemsCount:S,cartTotal:k,cartItemsCount:T,refreshCart:async()=>await p(),isLoadingCart:m},children:i})},d=t.createContext(),p=()=>{const e=t.useContext(d);if(!e)throw Error("useTheme must be used within a ThemeProvider");return e},h=({children:i})=>{const[a,r]=t.useState(()=>{const t=localStorage.getItem("theme")||"light";return"undefined"!=typeof document&&document.documentElement.setAttribute("data-theme",t),t});t.useEffect(()=>{localStorage.setItem("theme",a),document.documentElement.setAttribute("data-theme",a)},[a]);const s={theme:a,toggleTheme:()=>{r(t=>"light"===t?"dark":"light")},isDark:"dark"===a};return e.jsx(d.Provider,{value:s,children:i})};export{o as A,m as C,h as T,s as a,p as b,l as u};
