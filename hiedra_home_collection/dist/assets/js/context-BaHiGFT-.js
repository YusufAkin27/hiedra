import{r as t,j as e}from"./react-vendor-DfawjiNX.js";const i=t.createContext(),a="hiedra_auth",r=t=>{try{const e=(new Date).getTime()+2592e6,i={...t,expiry:e,savedAt:(new Date).getTime()};localStorage.setItem(a,JSON.stringify(i))}catch(e){}},o=()=>{const e=t.useContext(i);if(!e)throw Error("useAuth must be used within AuthProvider");return e},s=({children:o})=>{const[s,n]=t.useState(null),[c,u]=t.useState(!0),[l,m]=t.useState(null);t.useEffect(()=>{const t=(()=>{try{const t=localStorage.getItem(a);if(!t)return null;const e=JSON.parse(t);return e.expiry&&(new Date).getTime()>e.expiry?(localStorage.removeItem(a),null):e}catch(t){return null}})();t&&(n(t.user),m(t.accessToken)),u(!1)},[]);const d=async()=>{try{const e=(t,e=3e3)=>Promise.race([fetch(t,{method:"GET",headers:{Accept:"application/json"}}),new Promise((t,i)=>setTimeout(()=>i(Error("Timeout")),e))]);try{const t=await e("https://api.ipify.org?format=json",3e3);if(t.ok){const e=await t.json();if(e.ip&&""!==e.ip.trim()&&"127.0.0.1"!==e.ip&&"::1"!==e.ip)return e.ip.trim()}}catch(t){}try{const t=await e("https://api.ipify.org?format=text",3e3);if(t.ok){const e=await t.text();if(e&&""!==e.trim()&&"127.0.0.1"!==e.trim()&&"::1"!==e.trim())return e.trim()}}catch(t){}}catch(t){}return null},p={user:s,accessToken:l,isLoading:c,isAuthenticated:!!s,login:async(t,e)=>({success:!1,error:"Lütfen e-posta doğrulama kodu ile giriş yapın"}),logout:()=>{n(null),m(null),localStorage.removeItem(a)},requestCode:async t=>{try{const e="http://localhost:8080/api",i=await d(),a=await fetch(e+"/auth/request-code",{method:"POST",headers:{"Content-Type":"application/json",...i&&{"X-Client-IP":i}},body:JSON.stringify({email:t})}),r=await a.json();if(!a.ok)throw Error(r.message||"Kod gönderilemedi");if(r.isSuccess||r.success)return{success:!0,message:r.message};throw Error(r.message||"Kod gönderilemedi")}catch(e){return{success:!1,error:e.message||"Kod gönderilirken bir hata oluştu"}}},verifyCode:async(t,e)=>{try{const i="http://localhost:8080/api",a=await d(),o=await fetch(i+"/auth/verify-code",{method:"POST",headers:{"Content-Type":"application/json",...a&&{"X-Client-IP":a}},body:JSON.stringify({email:t,code:e})});if(!o.ok){const t=await o.json().catch(()=>({}));throw Error(t.message||"Doğrulama başarısız")}const s=await o.json();if(s.isSuccess||s.success){const e={user:s.data?.user||{email:t},accessToken:s.data?.accessToken||s.data?.token};return n(e.user),m(e.accessToken),r(e),{success:!0}}throw Error(s.message||"Doğrulama başarısız")}catch(i){return{success:!1,error:i.message||"Doğrulama yapılırken bir hata oluştu"}}},setUser:n,setAccessToken:m,saveAuthToStorage:r};return e.jsx(i.Provider,{value:p,children:o})},n=t.createContext(),c="hiedra_cart",u=t=>{try{const e={items:t,expiry:(new Date).getTime()+2592e6,savedAt:(new Date).getTime()};localStorage.setItem(c,JSON.stringify(e))}catch(e){}},l=()=>{const e=t.useContext(n);if(!e)throw Error("useCart must be used within CartProvider");return e},m=({children:i})=>{const{isAuthenticated:a,accessToken:r}=o(),[s,l]=t.useState([]),[m,d]=t.useState(!1),[p,h]=t.useState(0),[g,y]=t.useState(null),[f,S]=t.useState(null),k=async()=>{try{d(!0);let t=null;a&&r||(t=localStorage.getItem("guestUserId"));const e="http://localhost:8080/api/cart"+(t?"?guestUserId="+t:""),i=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json",...r&&{Authorization:"Bearer "+r}}});if(!i.ok)return l([]),[];const o=await i.json();if(o.isSuccess||o.success){const t=o.data||o;S(t.id||null),h(t.discountAmount?parseFloat(t.discountAmount):0),y(t.couponCode||null);const e=(t.items||[]).map(t=>{const e=t.subtotal?"string"==typeof t.subtotal?parseFloat(t.subtotal):parseFloat(t.subtotal.toString()):0,i=t.unitPrice?"string"==typeof t.unitPrice?parseFloat(t.unitPrice):parseFloat(t.unitPrice.toString()):0,a=t.product?.price?"string"==typeof t.product.price?parseFloat(t.product.price):parseFloat(t.product.price.toString()):0;return{id:t.product?.id||t.productId,name:t.product?.name||t.productName||"Ürün",price:i>0?i:a>0?a:0,image:t.product?.coverImageUrl||t.product?.image||"/images/perde1kapak.jpg",quantity:t.quantity||1,category:t.product?.category?.name||t.product?.category||"Genel",customizations:t.width||t.height||t.pleatType?{en:t.width,boy:t.height,pileSikligi:t.pleatType,calculatedPrice:e>0?e:i>0?i*(t.quantity||1):0}:null,itemKey:t.id?"backend_"+t.id:null,cartItemId:t.id}});return l(e),u(e),e}return l([]),[]}catch(t){return l([]),[]}finally{d(!1)}},T=t.useRef(!1),w=t.useRef({isAuthenticated:a,accessToken:r});t.useEffect(()=>{if(!T.current){const t=(()=>{try{const t=localStorage.getItem(c);if(!t)return[];const e=JSON.parse(t);return e.expiry&&(new Date).getTime()>e.expiry?(localStorage.removeItem(c),[]):e.items||[]}catch(t){return[]}})();t&&t.length>0&&l(t),T.current=!0}},[]),t.useEffect(()=>{w.current.isAuthenticated===a&&w.current.accessToken===r||!T.current?T.current||(w.current={isAuthenticated:a,accessToken:r}):(k(),w.current={isAuthenticated:a,accessToken:r})},[a,r]),t.useEffect(()=>{u(s)},[s]);const C=(t,e=null)=>{l(i=>e?i.filter(t=>t.itemKey!==e):i.filter(e=>e.id!==t))},b=t.useCallback(()=>s.reduce((t,e)=>t+(e.customizations?.calculatedPrice||e.price)*e.quantity,0)-p,[s,p]),z=t.useCallback(()=>s.reduce((t,e)=>t+(e.customizations?.calculatedPrice||e.price)*e.quantity,0),[s]),I=t.useCallback(()=>s.reduce((t,e)=>t+e.quantity,0),[s]),v=t.useMemo(()=>b(),[b]),A=t.useMemo(()=>I(),[I]);return e.jsx(n.Provider,{value:{cartItems:s,addToCart:(t,e={})=>{l(i=>{const a={...t,quantity:e.quantity||1,customizations:e.en||e.boy||e.pileSikligi?{en:e.en,boy:e.boy,pileSikligi:e.pileSikligi,calculatedPrice:e.calculatedPrice||t.price}:null},r=e.en||e.boy||e.pileSikligi?`${t.id}_${e.en}_${e.boy}_${e.pileSikligi}`:t.id;return i.find(e=>e.customizations&&a.customizations?e.id===t.id&&e.customizations.en===a.customizations.en&&e.customizations.boy===a.customizations.boy&&e.customizations.pileSikligi===a.customizations.pileSikligi:e.id===t.id&&!e.customizations&&!a.customizations)?i.map(i=>(i.customizations&&a.customizations?i.id!==t.id||i.customizations.en!==a.customizations.en||i.customizations.boy!==a.customizations.boy||i.customizations.pileSikligi!==a.customizations.pileSikligi:i.id!==t.id||i.customizations||a.customizations)?i:{...i,quantity:i.quantity+(e.quantity||1)}):[...i,{...a,itemKey:r}]})},removeFromCart:C,updateQuantity:(t,e,i=null)=>{e>0?l(a=>a.map(a=>i?a.itemKey===i?{...a,quantity:e}:a:a.id!==t||a.itemKey?a:{...a,quantity:e})):C(t,i)},clearCart:()=>{l([]),localStorage.removeItem(c)},getCartTotal:b,getCartSubtotal:z,getCartItemsCount:I,cartTotal:v,cartItemsCount:A,refreshCart:async()=>await k(),isLoadingCart:m,discountAmount:p,couponCode:g,cartId:f,setDiscountAmount:h,setCouponCode:y},children:i})},d=t.createContext(),p=()=>{const e=t.useContext(d);if(!e)throw Error("useTheme must be used within a ThemeProvider");return e},h=({children:i})=>{const[a,r]=t.useState(()=>{const t=localStorage.getItem("theme")||"light";return"undefined"!=typeof document&&document.documentElement.setAttribute("data-theme",t),t});t.useEffect(()=>{localStorage.setItem("theme",a),document.documentElement.setAttribute("data-theme",a)},[a]);const o={theme:a,toggleTheme:()=>{r(t=>"light"===t?"dark":"light")},isDark:"dark"===a};return e.jsx(d.Provider,{value:o,children:i})};export{s as A,m as C,h as T,o as a,p as b,l as u};
